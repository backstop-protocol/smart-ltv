import {
  Web3Function,
  Web3FunctionContext,
} from "@gelatonetwork/web3-functions-sdk";
import { BigNumber, Contract } from "ethers";
import ky from "ky"; // we recommend using ky as axios doesn't support fetch by default

// eslint-disable-next-line prettier/prettier
const TARGET_ALLOCATOR_ABI = [{"inputs":[{"internalType":"bytes32","name":"_idleMarketId","type":"bytes32"},{"internalType":"address","name":"_vault","type":"address"},{"internalType":"uint256","name":"_minDelayBetweenReallocations","type":"uint256"},{"internalType":"uint256","name":"_minReallocationSize","type":"uint256"},{"internalType":"address","name":"_keeperAddress","type":"address"},{"internalType":"bytes32[]","name":"_marketIds","type":"bytes32[]"},{"components":[{"internalType":"uint64","name":"maxUtilization","type":"uint64"},{"internalType":"uint64","name":"targetUtilization","type":"uint64"},{"internalType":"uint64","name":"minUtilization","type":"uint64"},{"internalType":"uint256","name":"minLiquidity","type":"uint256"}],"internalType":"struct TargetAllocator.TargetAllocation[]","name":"_targetAllocations","type":"tuple[]"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"bytes","name":"innerError","type":"bytes"}],"name":"CallError","type":"error"},{"inputs":[],"name":"IDLE_MARKET_ID","outputs":[{"internalType":"Id","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MORPHO","outputs":[{"internalType":"contract IMorpho","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"VAULT_ADDRESS","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes","name":"checkerBytecode","type":"bytes"}],"name":"checkReallocationNeeded","outputs":[{"internalType":"bool","name":"","type":"bool"},{"components":[{"components":[{"internalType":"address","name":"loanToken","type":"address"},{"internalType":"address","name":"collateralToken","type":"address"},{"internalType":"address","name":"oracle","type":"address"},{"internalType":"address","name":"irm","type":"address"},{"internalType":"uint256","name":"lltv","type":"uint256"}],"internalType":"struct MarketParams","name":"marketParams","type":"tuple"},{"internalType":"uint256","name":"assets","type":"uint256"}],"internalType":"struct MarketAllocation[]","name":"","type":"tuple[]"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"Id","name":"id","type":"bytes32"}],"name":"getTargetAllocation","outputs":[{"components":[{"internalType":"uint64","name":"maxUtilization","type":"uint64"},{"internalType":"uint64","name":"targetUtilization","type":"uint64"},{"internalType":"uint64","name":"minUtilization","type":"uint64"},{"internalType":"uint256","name":"minLiquidity","type":"uint256"}],"internalType":"struct TargetAllocator.TargetAllocation","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"}],"name":"isVaultAllocator","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"keeperAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes","name":"call","type":"bytes"}],"name":"keeperCall","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes","name":"checkerBytecode","type":"bytes"}],"name":"keeperCheck","outputs":[{"internalType":"bool","name":"","type":"bool"},{"internalType":"bytes","name":"call","type":"bytes"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"lastReallocationTimestamp","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minDelayBetweenReallocations","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minReallocationSize","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_newValue","type":"address"}],"name":"setKeeperAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newValue","type":"uint256"}],"name":"setMinDelayBetweenReallocations","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newValue","type":"uint256"}],"name":"setMinReallocationSize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"marketId","type":"bytes32"},{"components":[{"internalType":"uint64","name":"maxUtilization","type":"uint64"},{"internalType":"uint64","name":"targetUtilization","type":"uint64"},{"internalType":"uint64","name":"minUtilization","type":"uint64"},{"internalType":"uint256","name":"minLiquidity","type":"uint256"}],"internalType":"struct TargetAllocator.TargetAllocation","name":"targetAllocation","type":"tuple"}],"name":"setTargetAllocation","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"Id","name":"","type":"bytes32"}],"name":"targetAllocations","outputs":[{"internalType":"uint64","name":"maxUtilization","type":"uint64"},{"internalType":"uint64","name":"targetUtilization","type":"uint64"},{"internalType":"uint64","name":"minUtilization","type":"uint64"},{"internalType":"uint256","name":"minLiquidity","type":"uint256"}],"stateMutability":"view","type":"function"}]

// eslint-disable-next-line prettier/prettier
const CHECKER_BYTECODE = "0x608060405234801561001057600080fd5b506113d1806100206000396000f3fe608060405234801561001057600080fd5b506004361061004c5760003560e01c80634c796dae14610051578063571ecfc01461007b5780638f5dd339146100d4578063c3f1efbe146100dc575b600080fd5b61006461005f366004610e20565b6100fd565b604051610072929190610e95565b60405180910390f35b6100d2610089366004610efa565b600080546001600160a01b03199081166001600160a01b039788161790915560018054821695871695909517909455600280549094169290941691909117909155600355600455565b005b610064610547565b6100ef6100ea366004610f55565b61073b565b604051908152602001610072565b600254604051632c3c915760e01b81526004810185905260009160609183916001600160a01b031690632c3c91579060240160a060405180830381865afa15801561014c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101709190610f71565b60208101519091506001600160a01b031661018f57600092505061053f565b60008054604051639b8513df60e01b8152600481018990526001600160a01b0390911690639b8513df90602401608060405180830381865afa1580156101d9573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101fd9190611001565b9050806020015167ffffffffffffffff166000036102205760009350505061053f565b6002546000908190819061023d906001600160a01b0316866107b9565b509194509250905060008361025a83670de0b6b3a7640000611090565b61026491906110a7565b90506000856020015167ffffffffffffffff1683670de0b6b3a764000061028b9190611090565b61029591906110a7565b865190915067ffffffffffffffff1682111561039a5760006102c68c6102bb88856110c9565b808218908211021890565b90506004548110156102e35760009950505050505050505061053f565b6040805160028082526060820190925290816020015b610301610ce9565b8152602001906001900390816102f957905050985060405180604001604052808c8152602001828e61033391906110c9565b81525089600081518110610349576103496110dc565b602002602001018190525060405180604001604052808981526020016000198152508960018151811061037e5761037e6110dc565b602002602001018190525060019950505050505050505061053f565b856040015167ffffffffffffffff168210156105335760608601516103bf90846110f2565b8110156103d85760608601516103d590846110f2565b90505b60006104016103e88960a0902090565b6001546002546001600160a01b03908116929116610a2a565b90506000610410828888610ada565b9050600061041e86896110c9565b9050886060015181101561043f5760009b505050505050505050505061053f565b600061044f826102bb878c6110c9565b6004548482188583110290911891508110156104795760009c50505050505050505050505061053f565b6040805160028082526060820190925290816020015b610497610ce9565b81526020019060019003908161048f579050509b5060405180604001604052808c815260200182856104c991906110c9565b8152508c6000815181106104df576104df6110dc565b602002602001018190525060405180604001604052808f81526020016000198152508c600181518110610514576105146110dc565b602002602001018190525060019c50505050505050505050505061053f565b60009850505050505050505b935093915050565b600060606000600160009054906101000a90046001600160a01b03166001600160a01b03166333f91ebb6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156105a0573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105c49190611105565b600254600354604051632c3c915760e01b81529293506000926001600160a01b0390921691632c3c9157916105ff9160040190815260200190565b60a060405180830381865afa15801561061c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106409190610f71565b9050600061064d8261073b565b905060005b838110156106fd576001546040516362518ddf60e01b8152600481018390526000916001600160a01b0316906362518ddf90602401602060405180830381865afa1580156106a4573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106c89190611105565b90506000806106d88386886100fd565b9150915081156106f2576001999098509650505050505050565b505050600101610652565b50604080516000808252602082019092528161072f565b61071c610ce9565b8152602001906001900390816107145790505b50945094505050509091565b60025460009081908190819061075a906001600160a01b0316866107b9565b50600354600154600254949750929550909350600092610787926001600160a01b03918216929116610a2a565b90506000610796828686610ada565b905060006107a484876110c9565b82811890831102909118979650505050505050565b60008060008060006107cc8660a0902090565b604051632e3071cd60e11b8152600481018290529091506000906001600160a01b03891690635c60e39a9060240160c060405180830381865afa158015610817573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061083b9190611135565b9050600081608001516001600160801b03164261085891906110c9565b90508015801590610875575060408201516001600160801b031615155b156109f6576060880151604051638c00bf6b60e01b81526000916001600160a01b031690638c00bf6b906108af908c9087906004016111d4565b602060405180830381865afa1580156108cc573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108f09190611105565b905060006109156109018385610b07565b60408601516001600160801b031690610b74565b905061092081610b90565b84604001818151610931919061123b565b6001600160801b031690525061094681610b90565b8451859061095590839061123b565b6001600160801b0390811690915260a0860151161590506109f35760006109928560a001516001600160801b031683610b7490919063ffffffff16565b905060006109c88287600001516001600160801b03166109b291906110c9565b60208801518491906001600160801b0316610bf6565b90506109d381610b90565b866020018181516109e4919061123b565b6001600160801b031690525050505b50505b508051602082015160408301516060909301516001600160801b039283169b9183169a509282169850911695509350505050565b600080610a3f610a3a8585610c13565b610c87565b604051637784c68560e01b81529091506001600160a01b03861690637784c68590610a6e908490600401611262565b600060405180830381865afa158015610a8b573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052610ab391908101906112a6565b600081518110610ac557610ac56110dc565b602002602001015160001c9150509392505050565b6000610aff610aea6001856110f2565b610af7620f4240856110f2565b869190610cd2565b949350505050565b600080610b148385611090565b90506000610b358280610b30670de0b6b3a76400006002611090565b610cd2565b90506000610b518284610b30670de0b6b3a76400006003611090565b905080610b5e83856110f2565b610b6891906110f2565b93505050505b92915050565b6000610b898383670de0b6b3a7640000610cd2565b9392505050565b6040805180820190915260148152731b585e081d5a5b9d0c4c8e08195e18d95959195960621b60208201526000906001600160801b03831115610bef5760405162461bcd60e51b8152600401610be6919061134c565b60405180910390fd5b5090919050565b6000610aff610c08620f4240846110f2565b610af76001866110f2565b60008082846002604051602001610c34929190918252602082015260400190565b60408051601f1981840301815282825280516020918201206001600160a01b03909416908301528101919091526060016040516020818303038152906040528051906020012060001c610b8991906110f2565b60408051600180825281830190925260609160009190602080830190803683370190505090508281600081518110610cc157610cc16110dc565b602090810291909101015292915050565b600081610cdf8486611090565b610aff91906110a7565b6040805160e0810182526000918101828152606082018390526080820183905260a0820183905260c082018390528152602081019190915290565b634e487b7160e01b600052604160045260246000fd5b60405160a0810167ffffffffffffffff81118282101715610d5d57610d5d610d24565b60405290565b604051601f8201601f1916810167ffffffffffffffff81118282101715610d8c57610d8c610d24565b604052919050565b6001600160a01b0381168114610da957600080fd5b50565b600060a08284031215610dbe57600080fd5b610dc6610d3a565b90508135610dd381610d94565b81526020820135610de381610d94565b60208201526040820135610df681610d94565b60408201526060820135610e0981610d94565b806060830152506080820135608082015292915050565b600080600060e08486031215610e3557600080fd5b8335925060208401359150610e4d8560408601610dac565b90509250925092565b80516001600160a01b03908116835260208083015182169084015260408083015182169084015260608083015190911690830152608090810151910152565b600060408201841515835260206040602085015281855180845260608601915060208701935060005b81811015610eed578451610ed3848251610e56565b84015160a08401529383019360c090920191600101610ebe565b5090979650505050505050565b600080600080600060a08688031215610f1257600080fd5b8535610f1d81610d94565b94506020860135610f2d81610d94565b93506040860135610f3d81610d94565b94979396509394606081013594506080013592915050565b600060a08284031215610f6757600080fd5b610b898383610dac565b600060a08284031215610f8357600080fd5b610f8b610d3a565b8251610f9681610d94565b81526020830151610fa681610d94565b60208201526040830151610fb981610d94565b60408201526060830151610fcc81610d94565b60608201526080928301519281019290925250919050565b805167ffffffffffffffff81168114610ffc57600080fd5b919050565b60006080828403121561101357600080fd5b6040516080810181811067ffffffffffffffff8211171561103657611036610d24565b60405261104283610fe4565b815261105060208401610fe4565b602082015261106160408401610fe4565b6040820152606083015160608201528091505092915050565b634e487b7160e01b600052601160045260246000fd5b8082028115828204841417610b6e57610b6e61107a565b6000826110c457634e487b7160e01b600052601260045260246000fd5b500490565b81810381811115610b6e57610b6e61107a565b634e487b7160e01b600052603260045260246000fd5b80820180821115610b6e57610b6e61107a565b60006020828403121561111757600080fd5b5051919050565b80516001600160801b0381168114610ffc57600080fd5b600060c0828403121561114757600080fd5b60405160c0810181811067ffffffffffffffff8211171561116a5761116a610d24565b6040526111768361111e565b81526111846020840161111e565b60208201526111956040840161111e565b60408201526111a66060840161111e565b60608201526111b76080840161111e565b60808201526111c860a0840161111e565b60a08201529392505050565b61016081016111e38285610e56565b6001600160801b038084511660a08401528060208501511660c08401528060408501511660e084015280606085015116610100840152806080850151166101208401528060a085015116610140840152509392505050565b6001600160801b0381811683821601908082111561125b5761125b61107a565b5092915050565b6020808252825182820181905260009190848201906040850190845b8181101561129a5783518352928401929184019160010161127e565b50909695505050505050565b600060208083850312156112b957600080fd5b825167ffffffffffffffff808211156112d157600080fd5b818501915085601f8301126112e557600080fd5b8151818111156112f7576112f7610d24565b8060051b9150611308848301610d63565b818152918301840191848101908884111561132257600080fd5b938501935b8385101561134057845182529385019390850190611327565b98975050505050505050565b60006020808352835180602085015260005b8181101561137a5785810183015185820160400152820161135e565b506000604082860101526040601f19601f830116850101925050509291505056fea26469706673582212209557eaf785fe4d4b90aefdc00350f9bad5421d9fa7c9624bbbe061c350c28ce864736f6c63430008170033";

const parametersUrl = "https://something.com";

interface KeeperParameters {
  checkerBytecode: string;
  maxGasPriceWei: string;
}
Web3Function.onRun(async (context: Web3FunctionContext) => {
  const { userArgs, multiChainProvider } = context;
  // console.log("targetAllocatorAddress:", userArgs.targetAllocatorAddress);

  const parameters: KeeperParameters = await ky.get(parametersUrl).json();

  if (
    context.gelatoArgs.gasPrice.gt(BigNumber.from(parameters.maxGasPriceWei))
  ) {
    return {
      canExec: false,
      message: `Gas price too high: ${context.gelatoArgs.gasPrice.toString()} > ${
        parameters.maxGasPriceWei
      }`,
    };
  }

  const provider = multiChainProvider.default();

  console.log(provider.connection.url);
  const targetAllocatorAddress = userArgs.targetAllocatorAddress as string;
  if (!targetAllocatorAddress) {
    throw new Error("userArgs.targetAllocatorAddress not found");
  }

  const targetAllocatorContract = new Contract(
    targetAllocatorAddress,
    TARGET_ALLOCATOR_ABI,
    provider
  );

  const keeperCheckResponse =
    await targetAllocatorContract.callStatic.keeperCheck(CHECKER_BYTECODE);
  // const keeperCheckResponse =
  //   await targetAllocatorContract.callStatic.checkReallocationNeeded(
  //     checkerBytecode
  //   );

  // console.log(keeperCheckResponse);
  const mustReallocate = keeperCheckResponse[0];
  console.log(`mustReallocate: ${mustReallocate}`);

  if (mustReallocate) {
    const reallocateCallData = keeperCheckResponse[1];
    console.log(`reallocateCallData: ${reallocateCallData}`);

    return {
      canExec: true,
      callData: [
        {
          to: targetAllocatorAddress,
          data: targetAllocatorContract.interface.encodeFunctionData(
            "keeperCall",
            [reallocateCallData]
          ),
        },
      ],
    };
  } else {
    return { canExec: false, message: `No reallocation needed` };
  }
});
